// Prisma Schema for Bookshop ERP System
// Kutubxona ERP tizimi uchun ma'lumotlar bazasi sxemasi
// SQLite mos versiya (enum o'rniga String)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// ==================== USERS & AUTH ====================

model User {
  id        Int      @id @default(autoincrement())
  username  String   @unique
  password  String
  fullName  String
  phone     String?
  email     String?
  role      String   @default("CASHIER") // ADMIN, MANAGER, CASHIER, WAREHOUSE_STAFF
  branchId  Int?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  branch             Branch?             @relation(fields: [branchId], references: [id])
  sales              Sale[]
  purchases          Purchase[]
  financialMovements FinancialMovement[]
  productMovements   ProductMovement[]
  moneyTransfers     MoneyTransfer[]
}

// ==================== BRANCHES & WAREHOUSES ====================

model Branch {
  id        Int      @id @default(autoincrement())
  name      String
  address   String?
  phone     String?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  users         User[]
  warehouses    Warehouse[]
  cashRegisters CashRegister[]
  sales         Sale[]
}

model Warehouse {
  id              Int      @id @default(autoincrement())
  name            String
  branchId        Int?
  address         String?
  lowStockThreshold Int    @default(5)
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  branch           Branch?           @relation(fields: [branchId], references: [id])
  productStocks    ProductStock[]
  purchaseItems    PurchaseItem[]
  saleItems        SaleItem[]
  productMovements ProductMovement[]
}

// ==================== PRODUCTS ====================

model Category {
  id        Int       @id @default(autoincrement())
  name      String
  nameUz    String
  icon      String?
  isActive  Boolean   @default(true)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  products Product[]
}

model Author {
  id        Int       @id @default(autoincrement())
  name      String
  bio       String?
  country   String?
  isActive  Boolean   @default(true)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  products Product[]
}

model Product {
  id          Int      @id @default(autoincrement())
  name        String
  nameUz      String
  description String?
  isbn        String?  @unique
  barcode     String?  @unique
  image       String?
  categoryId  Int?
  authorId    Int?
  costPrice   Float    @default(0) // Sotib olish narxi
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  category         Category?         @relation(fields: [categoryId], references: [id])
  author           Author?           @relation(fields: [authorId], references: [id])
  prices           ProductPrice[]
  stocks           ProductStock[]
  purchaseItems    PurchaseItem[]
  saleItems        SaleItem[]
  productMovements ProductMovement[]
}

model ProductPrice {
  id         Int      @id @default(autoincrement())
  productId  Int
  currencyId Int
  price      Float
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  product  Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  currency Currency @relation(fields: [currencyId], references: [id])

  @@unique([productId, currencyId])
}

model ProductStock {
  id          Int      @id @default(autoincrement())
  productId   Int
  warehouseId Int
  quantity    Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  product   Product   @relation(fields: [productId], references: [id], onDelete: Cascade)
  warehouse Warehouse @relation(fields: [warehouseId], references: [id])

  @@unique([productId, warehouseId])
}

// ==================== SUPPLIERS ====================

model Supplier {
  id        Int      @id @default(autoincrement())
  name      String
  phone     String?
  email     String?
  address   String?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  purchases Purchase[]
}

// ==================== CURRENCIES & PAYMENTS ====================

model Currency {
  id        Int      @id @default(autoincrement())
  code      String   @unique // UZS, USD, RUB
  name      String
  nameUz    String
  symbol    String
  rate      Float    @default(1) // Kurs UZS ga nisbatan
  isDefault Boolean  @default(false)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  productPrices      ProductPrice[]
  cashRegisters      CashRegister[]
  sales              Sale[]
  purchases          Purchase[]
  financialMovements FinancialMovement[]
}

model PaymentType {
  id        Int      @id @default(autoincrement())
  name      String
  nameUz    String
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  sales              Sale[]
  financialMovements FinancialMovement[]
}

// ==================== CASH REGISTERS ====================

model CashRegister {
  id         Int      @id @default(autoincrement())
  name       String
  branchId   Int
  currencyId Int
  balance    Float    @default(0)
  isActive   Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  branch             Branch              @relation(fields: [branchId], references: [id])
  currency           Currency            @relation(fields: [currencyId], references: [id])
  sales              Sale[]
  financialMovements FinancialMovement[]
  transfersFrom      MoneyTransfer[]     @relation("TransferFrom")
  transfersTo        MoneyTransfer[]     @relation("TransferTo")
  circulatingFunds   CirculatingFund[]
}

// ==================== CIRCULATING FUNDS ====================

model CirculatingFund {
  id             Int      @id @default(autoincrement())
  cashRegisterId Int
  type           String   // DEPOSIT, WITHDRAWAL
  amount         Float
  depositorName  String?
  note           String?
  createdAt      DateTime @default(now())

  cashRegister CashRegister @relation(fields: [cashRegisterId], references: [id])
}

// ==================== FINANCIAL MOVEMENTS ====================

model FinancialMovement {
  id             Int      @id @default(autoincrement())
  cashRegisterId Int
  currencyId     Int
  paymentTypeId  Int?
  userId         Int
  type           String   // INFLOW, OUTFLOW
  amount         Float
  balanceAfter   Float
  referenceType  String?  // SALE, PURCHASE, TRANSFER, FUND, ADJUSTMENT
  referenceId    Int?
  note           String?
  createdAt      DateTime @default(now())

  cashRegister CashRegister @relation(fields: [cashRegisterId], references: [id])
  currency     Currency     @relation(fields: [currencyId], references: [id])
  paymentType  PaymentType? @relation(fields: [paymentTypeId], references: [id])
  user         User         @relation(fields: [userId], references: [id])
}

// ==================== MONEY TRANSFERS ====================

model MoneyTransfer {
  id               Int      @id @default(autoincrement())
  fromRegisterId   Int
  toRegisterId     Int
  userId           Int
  amount           Float
  note             String?
  createdAt        DateTime @default(now())

  fromRegister CashRegister @relation("TransferFrom", fields: [fromRegisterId], references: [id])
  toRegister   CashRegister @relation("TransferTo", fields: [toRegisterId], references: [id])
  user         User         @relation(fields: [userId], references: [id])
}

// ==================== PURCHASES ====================

model Purchase {
  id           Int      @id @default(autoincrement())
  supplierId   Int
  userId       Int
  currencyId   Int
  totalAmount  Float    @default(0)
  status       String   @default("PENDING") // PENDING, RECEIVED, CANCELLED
  note         String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  supplier Supplier       @relation(fields: [supplierId], references: [id])
  user     User           @relation(fields: [userId], references: [id])
  currency Currency       @relation(fields: [currencyId], references: [id])
  items    PurchaseItem[]
}

model PurchaseItem {
  id          Int      @id @default(autoincrement())
  purchaseId  Int
  productId   Int
  warehouseId Int
  quantity    Int
  unitPrice   Float
  totalPrice  Float
  createdAt   DateTime @default(now())

  purchase  Purchase  @relation(fields: [purchaseId], references: [id], onDelete: Cascade)
  product   Product   @relation(fields: [productId], references: [id])
  warehouse Warehouse @relation(fields: [warehouseId], references: [id])
}

// ==================== PRODUCT MOVEMENTS ====================

model ProductMovement {
  id            Int      @id @default(autoincrement())
  productId     Int
  warehouseId   Int
  userId        Int
  type          String   // IN, OUT, ADJUSTMENT
  quantity      Int
  quantityAfter Int
  referenceType String?  // SALE, PURCHASE, ADJUSTMENT, TRANSFER
  referenceId   Int?
  note          String?
  createdAt     DateTime @default(now())

  product   Product   @relation(fields: [productId], references: [id])
  warehouse Warehouse @relation(fields: [warehouseId], references: [id])
  user      User      @relation(fields: [userId], references: [id])
}

// ==================== SALES ====================

model Sale {
  id             Int      @id @default(autoincrement())
  branchId       Int
  cashRegisterId Int
  userId         Int
  currencyId     Int
  paymentTypeId  Int
  customerName   String?
  subtotal       Float
  discount       Float    @default(0)
  totalAmount    Float
  costTotal      Float    @default(0) // Sotib olish narxi jami
  profit         Float    @default(0) // Foyda
  note           String?
  createdAt      DateTime @default(now())

  branch       Branch       @relation(fields: [branchId], references: [id])
  cashRegister CashRegister @relation(fields: [cashRegisterId], references: [id])
  user         User         @relation(fields: [userId], references: [id])
  currency     Currency     @relation(fields: [currencyId], references: [id])
  paymentType  PaymentType  @relation(fields: [paymentTypeId], references: [id])
  items        SaleItem[]
}

model SaleItem {
  id          Int      @id @default(autoincrement())
  saleId      Int
  productId   Int
  warehouseId Int
  quantity    Int
  unitPrice   Float
  costPrice   Float    @default(0)
  totalPrice  Float
  profit      Float    @default(0)
  createdAt   DateTime @default(now())

  sale      Sale      @relation(fields: [saleId], references: [id], onDelete: Cascade)
  product   Product   @relation(fields: [productId], references: [id])
  warehouse Warehouse @relation(fields: [warehouseId], references: [id])
}
